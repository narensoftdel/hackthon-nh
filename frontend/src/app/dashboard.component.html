<div class="dashboard dashboard-flex">
  <button class="evacuate-btn" (click)="onEvacuate()" title="Evacuate Now">
    üö® Evacuate
  </button>
  <button class="alarm-btn" (click)="sendAlarmToAll()" title="Trigger Fire Alarm Email" style="margin-left:1em; background:#b71c1c; color:#fff; font-weight:600; border-radius:6px; padding:0.6em 1.2em; font-size:1em;">
    üîî Alarm
  </button>
  <div class="dashboard-left">
    <h2>Floors & Users</h2>
    <div class="accordion-list">
      <div class="accordion-item" *ngFor="let floor of sensorData; let i = index">
        <div class="accordion-header" (click)="floorAccordion[i] = !floorAccordion[i]" [class.open]="floorAccordion[i]" [class.bad-floor]="isFloorBad(i)">
          <span class="floor-label" [class.bad-floor-label]="isFloorBad(i)" style="font-weight:600; font-size:1.1em; cursor:pointer;">
            üè¢ Floor {{ i + 1 }}
          </span>
          <span class="arrow-icon" (click)="selectFloor(i+1); $event.stopPropagation();" title="Go to Floor View" style="margin-left:0.7em; cursor:pointer; font-size:1.3em; padding-left:0.5em;">&#8594;</span>
        </div>
        <div class="accordion-body" *ngIf="floorAccordion[i]">
          <ul style="margin:0; padding-left:1.2em;">
            <li *ngFor="let user of getUsersForFloor(i+1)">
              {{ user.name }} ({{ user.email }})
            </li>
          </ul>
          <div style="margin-top: 0.7em; display: flex; gap: 0.5em; align-items: center;">
            <button (click)="toggleTesting(i); $event.stopPropagation();" [ngClass]="{'testing-btn': true, 'active': floorTesting[i]}">
              Testing: <b>{{ floorTesting[i] ? 'true' : 'false' }}</b>
            </button>
            <button (click)="triggerFireAlarm(i); $event.stopPropagation();" [disabled]="sensorData[i]?.fireAlarm" style="background:#b71c1c; color:#fff; border-radius:5px; padding:0.3em 0.8em; font-weight:600;">Trigger</button>
            <button (click)="resetFireAlarm(i); $event.stopPropagation();" [disabled]="!sensorData[i]?.fireAlarm" style="background:#388e3c; color:#fff; border-radius:5px; padding:0.3em 0.8em; font-weight:600;">Reset</button>
            <button (click)="simulateTvoc(i); $event.stopPropagation();" style="background:#ff9800; color:#fff; border-radius:5px; padding:0.3em 0.8em; font-weight:600;">Simulate TVOC</button>
          </div>
        </div>
      </div>
    </div>
  </div>
    <div class="dashboard-right">
    <h2>Sensor Dashboard</h2>
    <div *ngIf="loading">Loading...</div>
    <div *ngIf="error">{{ error }}</div>
    <div *ngIf="!loading && !error">
      <div class="building-view" *ngIf="selectedFloor === null">
        <h3>Building Level View (Averages)</h3>
        <div class="card-group">
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(getBuildingAvgData()).group1" [ngClass]="sensor.status">
              <div class="sensor-card-row">
                <span class="sensor-icon">{{ sensor.icon }}</span>
                <span class="sensor-type">{{ sensor.label }}</span>
              </div>
              <div class="sensor-card-row sensor-card-row-bottom">
                <div style="display:flex; flex-direction:column; align-items:flex-start; flex:1;">
                  <span class="sensor-value">
                    <ng-container *ngIf="sensor.label === 'Temperature'">
                      {{ sensor.value.split(' ')[0] }}<span style="font-size:0.95em; color:#888;"> ¬∞C</span>
                    </ng-container>
                    <ng-container *ngIf="sensor.label === 'Humidity'">
                      {{ sensor.value.split(' ')[0] }}<span style="font-size:0.95em; color:#888;"> %</span>
                    </ng-container>
                    <ng-container *ngIf="sensor.label !== 'Temperature' && sensor.label !== 'Humidity'">
                      {{ sensor.value }}
                    </ng-container>
                  </span>
                </div>
                <div class="sensor-range-stack" *ngIf="sensor.range">
                  <ng-container *ngFor="let r of getStackedRanges(sensor.label)">
                    <span class="sensor-range-item" [ngClass]="r.type">{{ r.text }}</span>
                  </ng-container>
                </div>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta">{{ sensor.meta }}</div>
            </div>
          </div>
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(getBuildingAvgData()).group2" [ngClass]="sensor.status">
              <div class="sensor-card-row">
                <span class="sensor-icon">{{ sensor.icon }}</span>
                <span class="sensor-type">{{ sensor.label }}</span>
              </div>
              <div class="sensor-card-row sensor-card-row-bottom">
                <div style="display:flex; flex-direction:column; align-items:flex-start; flex:1;">
                  <span class="sensor-value">{{ sensor.value }}</span>
                </div>
                <div class="sensor-range-stack" *ngIf="sensor.label === 'Temperature' || sensor.label === 'Humidity'">
                  <ng-container *ngFor="let r of getStackedRanges(sensor.label)">
                    <span class="sensor-range-item" [ngClass]="r.type">{{ r.text }}</span>
                  </ng-container>
                </div>
                <span class="sensor-range" *ngIf="sensor.range && sensor.label !== 'Temperature' && sensor.label !== 'Humidity'">{{ sensor.range }}</span>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta">{{ sensor.meta }}</div>
            </div>
          </div>
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(getBuildingAvgData()).misc" [ngClass]="sensor.status">
              <div class="sensor-card-row">
                <span class="sensor-icon">{{ sensor.icon }}</span>
                <span class="sensor-type">{{ sensor.label }}</span>
              </div>
              <div class="sensor-card-row sensor-card-row-bottom">
                <span class="sensor-value">{{ sensor.value }}</span>
                <span class="sensor-range" *ngIf="sensor.range">{{ sensor.range }}</span>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta">{{ sensor.meta }}</div>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedFloor !== null">
        <button class="icon-back-btn" (click)="showBuildingView()" title="Back to Building View">
          <span style="font-size:1.3em; vertical-align:middle;">&#8592;</span>
          <span style="margin-left:0.5em; vertical-align:middle; font-weight:600;">Building View</span>
        </button>
        <h3>Floor {{ selectedFloor }}</h3>
        <div class="card-group">
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(sensorData[selectedFloor-1]).group1" [ngClass]="sensor.status">
              <div style="display:flex; align-items:center; gap:0.7em; width:100%;">
                <span class="sensor-icon" style="font-size:1.7em;">{{ sensor.icon }}</span>
                <span class="sensor-type" style="font-weight:600; font-size:1.1em;">{{ sensor.label }}</span>
              </div>
              <div style="display:flex; align-items:center; gap:0.7em; width:100%; justify-content:space-between;">
                <span class="sensor-value" style="font-size:1.25em; font-weight:500;">{{ sensor.value }}</span>
                <span class="sensor-range" *ngIf="sensor.range" style="background:linear-gradient(90deg,#f5f5f5 70%,#e3f2fd 100%); border-radius:6px; padding:0.18em 0.9em; font-size:0.92em; color:#1976d2; font-weight:500; min-width:120px; text-align:right; letter-spacing:0.01em;">{{ sensor.range }}</span>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta" style="font-size:0.93em; color:#888; margin-top:0.1em;">{{ sensor.meta }}</div>
            </div>
          </div>
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(sensorData[selectedFloor-1]).group2" [ngClass]="sensor.status">
              <div style="display:flex; align-items:center; gap:0.7em; width:100%;">
                <span class="sensor-icon" style="font-size:1.7em;">{{ sensor.icon }}</span>
                <span class="sensor-type" style="font-weight:600; font-size:1.1em;">{{ sensor.label }}</span>
              </div>
              <div style="display:flex; align-items:center; gap:0.7em; width:100%; justify-content:space-between;">
                <div style="display:flex; flex-direction:column; align-items:flex-start; flex:1;">
                  <span class="sensor-value" style="font-size:1.25em; font-weight:500;">
                    <ng-container *ngIf="sensor.label === 'Temperature'">
                      {{ sensor.value.split(' ')[0] }}<span style="font-size:0.95em; color:#888;"> ¬∞C</span>
                    </ng-container>
                    <ng-container *ngIf="sensor.label === 'Humidity'">
                      {{ sensor.value.split(' ')[0] }}<span style="font-size:0.95em; color:#888;"> %</span>
                    </ng-container>
                    <ng-container *ngIf="sensor.label !== 'Temperature' && sensor.label !== 'Humidity'">
                      {{ sensor.value }}
                    </ng-container>
                  </span>
                </div>
                <div class="sensor-range-stack" *ngIf="sensor.label === 'Temperature' || sensor.label === 'Humidity'">
                  <ng-container *ngFor="let r of getStackedRanges(sensor.label)">
                    <span class="sensor-range-item" [ngClass]="r.type">{{ r.text }}</span>
                  </ng-container>
                </div>
                <span class="sensor-range" *ngIf="sensor.range && sensor.label !== 'Temperature' && sensor.label !== 'Humidity'" style="background:linear-gradient(90deg,#f5f5f5 70%,#e3f2fd 100%); border-radius:6px; padding:0.18em 0.9em; font-size:0.92em; color:#1976d2; font-weight:500; min-width:120px; text-align:right; letter-spacing:0.01em;">{{ sensor.range }}</span>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta" style="font-size:0.93em; color:#888; margin-top:0.1em;">{{ sensor.meta }}</div>
            </div>
          </div>
          <div class="card-container">
            <div class="sensor-card" *ngFor="let sensor of getSensorCards(sensorData[selectedFloor-1]).misc" [ngClass]="sensor.status">
              <div style="display:flex; align-items:center; gap:0.7em; width:100%;">
                <span class="sensor-icon" style="font-size:1.7em;">{{ sensor.icon }}</span>
                <span class="sensor-type" style="font-weight:600; font-size:1.1em;">{{ sensor.label }}</span>
              </div>
              <div style="display:flex; align-items:center; gap:0.7em; width:100%; justify-content:space-between;">
                <span class="sensor-value" style="font-size:1.25em; font-weight:500;">{{ sensor.value }}</span>
                <span class="sensor-range" *ngIf="sensor.range" style="background:linear-gradient(90deg,#f5f5f5 70%,#e3f2fd 100%); border-radius:6px; padding:0.18em 0.9em; font-size:0.92em; color:#1976d2; font-weight:500; min-width:120px; text-align:right; letter-spacing:0.01em;">{{ sensor.range }}</span>
              </div>
              <div class="sensor-meta" *ngIf="sensor.meta" style="font-size:0.93em; color:#888; margin-top:0.1em;">{{ sensor.meta }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
